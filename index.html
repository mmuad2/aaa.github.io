<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Vue2 + Supabase Auth</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="app">
  <h2>Vue2 + Supabase 登录控制</h2>

  <!-- 未登录 -->
  <div v-if="!user">
    <h3>登录</h3>
    <input v-model="email" placeholder="邮箱" />
    <input v-model="password" type="password" placeholder="密码" />
    <button @click="login">登录</button>
  </div>

  <!-- 已登录 -->
  <div v-else>
    <p>当前用户：{{ user.email }}</p>
    <button @click="logout">退出登录</button>

    <hr>

    <button @click="loadData">加载数据</button>
    <ul>
      <li v-for="u in list" :key="u.id">
        {{ u.name }} - {{ u.age }}
      </li>
    </ul>
  </div>
</div>

<script>
const client = supabase.createClient(
  'https://rwqpcdhwpwucjpdnpgaw.supabase.co',
  'sb_publishable_wB1IcMNZ4OHo0ZuQdWz5GQ_2DuzP_UY'
)

new Vue({
  el: '#app',
  data: {
    email: '',
    password: '',
    user: null,
    list: []
  },
  async mounted() {
    // 页面刷新后自动恢复登录状态
    const { data } = await client.auth.getUser()
    this.user = data.user
  },
  methods: {
    async login() {
      const { data, error } = await client.auth.signInWithPassword({
        email: this.email,
        password: this.password
      })

      if (error) {
        alert(error.message)
        return
      }
      this.user = data.user
      this.loadData()
    },

    async logout() {
      await client.auth.signOut()
      this.user = null
      this.list = []
    },

    async loadData() {
      const { data, error } = await client
        .from('aaa')
        .select('*')

      if (error) {
        alert(error.message)
        return
      }
      this.list = data
    }
  }
})
</script>

</body>
</html>
